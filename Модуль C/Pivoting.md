# SSH туннели

## SSH local port forwarding

При переадресации локальных портов все сетевые пакеты пересылаются с определенного локального порта SSH клиента на указанный IP и порт. В этом случае между клиентом и сервером поднимается SSH соединение, при этом на клиенте открывается порт, и все пакеты, отправленные на этот порт, туннелируются через SSH соединение на сервер, где в дальнейшем пересылаются сервером на указанные хост и порт.

Переадресацию локального порта можно осуществить через опцию -L команды ssh. В данном параметре необходимо через двоеточие указать локальные адрес (LHOST) и порт (LPORT), который будут принимать соединение и удаленные адрес (RHOST) и порт (RPORT), куда будет пересылаться трафик. Если локальный адрес не указывать, по умолчанию будет использован 0.0.0.0. Одновременно будет открыта обычная сессия SSH, при этом если нужно, чтобы командная оболочка не запускалась, можно использовать параметр -N.

```
ssh [login]@[address] -L [LPORT]:[RHOST]:[RPORT] -N
```

Теперь подключение к локальному порту 445 будет транслировано как подключение к порту 445 изолированного хоста.

## SSH remote port forwarding

Отличие от переадресации локального порта заключается в том, что прослушивающий порт открывается не на клиенте SSH, а на сервере. Таким образом, все сетевые пакеты, приходящие на этот порт на удаленной машине, будут пересылаться на указанный порт SSH клиента.

Аналогично предыдущему примеру можно сделать переадресацию удаленного порта 8000 удаленной машины на порт 80 машины атакующего.

Переадресацию удаленного порта можно осуществить через опцию -R команды ssh. В данном параметре необходимо через двоеточие указать удаленные адрес (RHOST) и порт (RPORT), который будут принимать соединение и локальные адрес (LHOST) и порт (LPORT), куда будет пересылаться трафик.

```
ssh student@10.2.0.251 -R 8000:0.0.0.0:80
```

Теперь можно с удаленного хоста выполнить запрос по адресу 127.0.0.1:8000, который будет переадресован через SSH туннель на веб-сервер, запущенный на машине атакующего.

## SSH socks туннель

Динамическую переадресацию можно осуществить через опцию -D команды ssh. В данном параметре необходимо указать локальные адрес (LHOST) и порт (LPORT), которые будут принимать соединение. Если локальный адрес не указывать, по умолчанию будет использован 0.0.0.0.

```
ssh [login]@[address] -D [LPORT] -N
```

Но как выполнить подключение по SMB к изолированной машине, если NetExec не имеет встроенной возможности использовать SOCKS прокси? В таких случаях можно использовать популярную утилиту proxychains.

```
proxychains -q nxc smb 10.1.0.5
proxychains nmap 10.1.0.5 -sT -Pn -n
```

## ProxyJump

Это способы доступа к хосту через промежуточную машину (jump host) без ручного создания туннелей. Например:

Attacker → 10.10.10.5 (jump) → 192.168.1.50 (target)

```
ssh -J user@10.10.10.5 root@192.168.1.50
```

Добавление форвардов через ProxyJump:

```
ssh -J user@jump -L 13389:192.168.1.50:3389 attacker@jump
```

# Chisel

Как правило, на машине атакующего запускается серверная часть chisel server, которая ожидает подключение (параметр --reverse) от клиентских модулей с удаленных машин, на указанный порт (параметр --port).

```
chisel server --port 8000 --reverse
```

## Remote port forwarding

Для переадресации удаленного порта необходимо на удаленной машине запустить chisel client с указанием адреса серверной части chisel, а затем через двоеточие указать удаленные адрес сервера (RHOST) и порт (RPORT), который будут принимать соединение и локальные адрес (LHOST) и порт (LPORT), куда будет пересылаться трафик. Очень похоже с методом SSH.

```
.\chisel.exe client 10.0.0.251:8000 0.0.0.0:80:127.0.0.1:80
```

## Local port forwarding

Для переадресации локального порта в настройках chisel client нужно через опцию R и двоеточие указать локальный порт (LPORT), удаленные адрес (RHOST) и порт (RPORT).

```
.\chisel.exe client 10.0.0.251:8000 R:445:10.1.0.5:445
```

## Socks proxy

Построить socks туннель с помощью chisel еще проще. Для этого через опцию R нужно указать локальный порт (LPORT), принимающий соединение, и обозначение socks.

```
.\chisel.exe client 10.0.0.251:8000 R:1080:socks
```
